# 兑换码激活功能说明

## 功能概述

已成功为化妆品知识测试添加兑换码激活功能，用于防止大量传播，同时便于自动发货。

## 核心特性

### 1. 固定兑换码
- **兑换码**: `COSMETICS2026`
- 所有用户使用同一个兑换码
- 便于自动发货，无需为每个用户生成不同的码

### 2. 设备绑定机制
- 使用浏览器指纹技术生成设备唯一标识
- 兑换码激活后与设备绑定
- 同一设备只需激活一次，后续访问自动识别
- 换设备需要重新输入兑换码

### 3. 浏览器指纹组成
生成的设备指纹包含以下信息：
- User Agent（浏览器标识）
- 屏幕分辨率和色深
- 时区
- 语言设置
- 操作系统平台
- CPU核心数
- 设备内存（如果可用）
- Canvas指纹（图形渲染特征）

## 使用流程

### 用户首次访问
1. 打开网站，自动弹出激活弹窗
2. 输入兑换码 `COSMETICS2026`
3. 点击"激活并开始测试"
4. 激活成功后，弹窗关闭，显示测试选项
5. 可以正常开始测试

### 用户再次访问
1. 打开网站
2. 系统自动检测设备是否已激活
3. 如果已激活，直接显示测试选项
4. 无需重新输入兑换码

## 技术实现

### 文件结构
```
cosmetics-quiz/
├── src/
│   ├── utils/
│   │   └── deviceFingerprint.ts    # 设备指纹和验证逻辑
│   ├── components/
│   │   └── ActivationModal.tsx     # 激活弹窗组件
│   └── app/
│       └── page.tsx                # 首页（已集成激活功能）
```

### 核心函数

#### [`deviceFingerprint.ts`](cosmetics-quiz/src/utils/deviceFingerprint.ts:1)
- `generateDeviceFingerprint()` - 生成设备指纹
- `validateActivationCode()` - 验证兑换码
- `isDeviceActivated()` - 检查设备是否已激活
- `activateDevice()` - 激活设备
- `clearActivation()` - 清除激活状态（测试用）

#### [`ActivationModal.tsx`](cosmetics-quiz/src/components/ActivationModal.tsx:1)
- 美观的激活弹窗界面
- 输入验证和错误提示
- 自动转换为大写

#### [`page.tsx`](cosmetics-quiz/src/app/page.tsx:1)
- 集成激活检测逻辑
- 未激活时显示锁定状态
- 激活后显示正常测试选项

## 数据存储

### LocalStorage 存储结构
```json
{
  "fingerprint": "设备指纹哈希值",
  "activated": true,
  "activatedAt": "2026-01-29T09:34:00.000Z",
  "code": "COSMETICS2026"
}
```

存储键名：`cosmetics_activation`

## 安全性说明

### 优点
✅ 简单实用，无需后端
✅ 固定兑换码便于自动发货
✅ 设备绑定限制传播
✅ 对普通用户有效

### 局限性
⚠️ 技术用户可以清除 localStorage 绕过
⚠️ 固定兑换码理论上可以被分享
⚠️ 更换浏览器或清除数据需要重新激活

### 适用场景
- ✅ 1元小额付费产品
- ✅ 防止大规模传播
- ✅ 不需要严格的授权管理
- ❌ 不适合高价值产品
- ❌ 不适合需要严格防盗版的场景

## 修改兑换码

如需修改兑换码，编辑 [`deviceFingerprint.ts`](cosmetics-quiz/src/utils/deviceFingerprint.ts:60) 文件：

```typescript
export function validateActivationCode(code: string): boolean {
  // 修改这里的兑换码
  const VALID_CODE = 'COSMETICS2026';
  return code.trim().toUpperCase() === VALID_CODE;
}
```

## 测试说明

### 测试激活功能
1. 访问 http://localhost:3000
2. 输入兑换码 `COSMETICS2026`
3. 验证激活成功

### 测试设备绑定
1. 激活后刷新页面
2. 应该直接显示测试选项，无需重新输入

### 清除激活状态
在浏览器控制台执行：
```javascript
localStorage.removeItem('cosmetics_activation');
location.reload();
```

## 部署注意事项

1. **环境变量**：无需配置，纯前端实现
2. **兼容性**：支持所有现代浏览器
3. **性能**：指纹生成在客户端完成，不影响服务器
4. **隐私**：所有数据存储在用户本地，不上传服务器

## 后续优化建议

如果需要更严格的控制，可以考虑：

1. **方案A：唯一兑换码**
   - 为每个用户生成唯一兑换码
   - 需要后端API验证
   - 更安全但发货复杂

2. **方案B：使用次数限制**
   - 限制固定兑换码的激活次数
   - 需要后端记录激活次数
   - 平衡安全性和便利性

3. **方案C：时间限制**
   - 激活后有效期限制
   - 到期需要重新激活
   - 适合订阅制产品

## 常见问题

**Q: 用户清除浏览器数据后怎么办？**
A: 需要重新输入兑换码激活，这是设计预期。

**Q: 用户换设备怎么办？**
A: 需要重新输入兑换码，每个设备独立激活。

**Q: 兑换码被分享怎么办？**
A: 这是固定码的局限性，但设备绑定会限制传播范围。对于1元产品，这个方案已经足够。

**Q: 如何统计激活数量？**
A: 当前纯前端方案无法统计。如需统计，需要添加后端API。

## 总结

这是一个简单实用的激活方案，适合小额付费产品。通过设备指纹绑定，在不增加复杂度的前提下，有效限制了大规模传播。
